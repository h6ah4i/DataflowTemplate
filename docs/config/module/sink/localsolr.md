# Local Solr Sink Module (Experimental)

Sink module to create solr index file to specified GCS path.

The index files generated by this module can be easily imported into [Solr docker official image](https://hub.docker.com/_/solr) to build a Solr search API server.
(This module generates index file for Solr version 9)

## Sink module common parameters

| parameter  | optional | type                | description                                       |
|------------|----------|---------------------|---------------------------------------------------|
| name       | required | String              | Step name. specified to be unique in config file. |
| module     | required | String              | Specified `localSolr`                             |
| inputs     | required | Array<String\>      | Step names whose data you want to write from      |
| parameters | required | Map<String,Object\> | Specify the following individual parameters.      |

## Local Solr sink module parameters

| parameter     | optional | type           | description                                                                                                          |
|---------------|----------|----------------|----------------------------------------------------------------------------------------------------------------------|
| output        | required | String         | GCS path for solr index file writing destination. Index files are compressed as a zip file.                          |
| cores         | required | Array<Core\>   | Define Solr core settings. You can create one index file by creating multiple cores from multiple inputs.            |
| tempDirectory | optional | String         | The GCS path of the temporary file export destination. If not specified, the bucket creation permission is required. |

## Core parameters

| parameter         | optional | type                 | description                                                                                                                                                                                                                                                            |
|-------------------|----------|----------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| input             | required | String               | Specify the input name used for the core insertion.                                                                                                                                                                                                                    |
| name              | required | String               | Solr core name to create index.                                                                                                                                                                                                                                        |
| schema            | optional | String               | GCS path for [solr index schema.xml](https://solr.apache.org/guide/solr/latest/indexing-guide/schema-elements.html). If not specified, it is automatically inferred from the input data schema. (It is strongly recommended to specify it according to your use case.) |
| config            | optional | String or SolrConfig | GCS path for [solrconfig.xml](https://solr.apache.org/guide/solr/latest/configuration-guide/configuring-solrconfig-xml.html) or following `SolrConfig` json format if you want to set detailed index generation settings.                                              |
| customConfigFiles | optional | Array<ConfigFile\>   | If there are external files, such as user dictionaries, synonym etc, that you wish to reference during index generation, specify the external file information.                                                                                                        |

### SolrConfig parameter schema

If you want to configure the index generation environment in detail, specify parameter `cores[].config`.
The `config` parameter supports the following fields (with default values). Please refer to the [solrconfig.xml doc](https://solr.apache.org/guide/solr/latest/configuration-guide/configuring-solrconfig-xml.html) for detail of the fields.

(This setting is for index generation. It is recommended to replace solrconfig.xml when deploying the server)

```json
{
  "directoryFactory": {
    "className": "solr.NRTCachingDirectoryFactory"
  },
  "codecFactory": {
    "className": "solr.SchemaCodecFactory",
    "compressionMode": "BEST_SPEED"
  },
  "indexConfig": {
    "ramBufferSizeMB": 100,
    "maxBufferedDocs": 1000,
    "useCompoundFile": false,
    "ramPerThreadHardLimitMB": 1945
  },
  "libs": [
    {
      "dir": "",
      "regex": ".*\\.jar"
    }
  ],
  "luceneMatchVersion": "9.0.0"
}
```

### ConfigFile parameter schema

If you want to refer to a custom file such as a dictionary when generating the index, you can specify `customConfigFiles` parameter to load files placed in GCS under `{SOLR_HOME}/{CORE}/conf`.

| parameter | optional | type   | description                                                                                                 |
|-----------|----------|--------|-------------------------------------------------------------------------------------------------------------|
| input     | required | String | Specify the GCS path where you placed the file you want to refer to when generating the index               |
| filename  | optional | String | Specify the name of the file to be copied in `{SOLR_HOME}/{CORE}/conf` directory when generating the index. |

## Import index file into solr official docker image

To import the generated index file into the official solr docker image, download the index file, unzip, and run the Dockerfile as shown in the example below.

* [Dockerfile](../../../../examples/Dockerfile_solr)

To upload an image with the index included to [Artifact Registry](https://cloud.google.com/artifact-registry) using this Dockerfile, execute the following command

```bash
docker build -f Dockerfile -t $_REGION-docker.pkg.dev/$PROJECT_ID/solr/myindex .
```

Note: The solrconfig.xml for index generation defines a request handler with `/select` as an endpoint by default, but it is recommended to define a customized solrconfig.xml (and solr.xml) according to your use case and replace it in the Dockerfile.

## Deploy Solr server on Cloud Run

To deploy a solr API server on Cloud Run using Cloud Build, prepare and run the following cloudbuild file.

* [cloudbuild.yaml](../../../../examples/cloudbuild_solr.yaml)

Then execute the following command.

```shell
gcloud builds submit --config=cloudbuild.yaml --project=myproject
```

## Related example config files

* [BigQuery to Solr Index(PDF parse)](../../../../examples/bigquery-pdf-to-localsolr.json)
