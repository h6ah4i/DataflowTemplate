# LocalNeo4j Sink Module (Experimental)

Sink module to create Neo4j database file to specified GCS path.

The index files generated by this module can be easily imported into [Neo4j docker official image](https://hub.docker.com/_/neo4j/) to build Neo4j API server.
(This module generates database file for Neo4j version 5.19.0)

## Sink module common parameters

| parameter  | optional | type                | description                                       |
|------------|----------|---------------------|---------------------------------------------------|
| name       | required | String              | Step name. specified to be unique in config file. |
| module     | required | String              | Specified `localNeo4j`                            |
| inputs     | required | Array<String\>      | Step names whose data you want to write from      |
| parameters | required | Map<String,Object\> | Specify the following individual parameters.      |

## LocalNeo4j sink module parameters

| parameter       | optional | type                       | description                                                                                                                                                                                                                                                                        |
|-----------------|----------|----------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| output          | required | String                     | GCS path for neo4j database file writing destination. Database files are compressed as a dump file or zip file. (When output in dump format, the file name must be `{database name}.dump` when loading into the DB)                                                                |
| database        | optional | String                     | Database name. The default is `neo4j`. (If you are using Neo4j Community version, only `neo4j` can be specified)                                                                                                                                                                   |
| conf            | optional | String                     | GCS path for [neo4j conf file](https://neo4j.com/docs/operations-manual/current/configuration/neo4j-conf/)                                                                                                                                                                         |
| nodes           | required | Array<NodeConfig\>         | Definition of conversion from input records to the [Node](https://neo4j.com/docs/getting-started/appendix/graphdb-concepts/#graphdb-node) to be saved                                                                                                                              |
| relationships   | required | Array<RelationshipConfig\> | Definition of conversion from input records to the [Relationship](https://neo4j.com/docs/getting-started/appendix/graphdb-concepts/#graphdb-relationship) to be saved                                                                                                              |
| setupCyphers    | optional | Array<String\>             | Specify the Cypher queries you wish to run at startup, such as index definitions.                                                                                                                                                                                                  |
| teardownCyphers | optional | Array<String\>             | Specify the Cypher queries you wish to run at teardown, such as index definitions.                                                                                                                                                                                                 |
| format          | optional | Enum                       | Specify database exported file format. You can specify [dump](https://neo4j.com/docs/operations-manual/current/backup-restore/offline-backup/) or `zip`. The default is `dump`.                                                                                                    |
| bufferSize      | optional | Integer                    | Specify the buffer size to write to the database. The default is 1000                                                                                                                                                                                                              |
| useGDS          | optional | Boolean                    | Specify true if you want to use the [GDS library](https://neo4j.com/docs/graph-data-science/current/). In this case, you need to [download the GDS library jar file](https://neo4j.com/deployment-center/#gds-tab) and place it under src/main/resources/libs and deploy Template. |
| tempDirectory   | optional | String                     | The GCS path of the temporary file export destination. If not specified, the bucket creation permission is required.                                                                                                                                                               |

## NodeConfig parameters

| parameter      | optional | type           | description                                                                                                                                                                                 |
|----------------|----------|----------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| input          | required | String         | Specify the input name used for node generation.                                                                                                                                            |
| labels         | required | Array<String\> | Specify labels to be assigned to the generated node.                                                                                                                                        |
| keyFields      | required | Array<String\> | Specify fields with unique key values to be assigned to the node to be generated. Input record schema must have these fields. The values of fields specified here are stored as properties. |
| propertyFields | optional | Array<String\> | Specify fields you wish to assign as properties to the node to be generated. Input record schema must have these fields.                                                                    |

## RelationshipConfig parameters

| parameter      | optional | type           | description                                                                                                                                                                                         |
|----------------|----------|----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| input          | required | String         | Specify the input name used for relationship generation.                                                                                                                                            |
| type           | required | String         | Specify the type name to be assigned to the generated relationship.                                                                                                                                 |
| source         | required | RelNodeConfig  | Specifies source node information for the relationship.                                                                                                                                             |
| target         | required | RelNodeConfig  | Specifies target node information for the relationship.                                                                                                                                             |
| keyFields      | required | Array<String\> | Specify fields with unique key values to be assigned to the relationship to be generated. Input record schema must have these fields. The values of fields specified here are stored as properties. |
| propertyFields | optional | Array<String\> | Specify fields you wish to assign as properties to the node to be generated. Input record schema must have these fields.                                                                            |

## RelNodeConfig parameters

| parameter      | optional | type           | description                                                                 |
|----------------|----------|----------------|-----------------------------------------------------------------------------|
| label          | required | String         | Specify a label to filter node.                                             |
| keyFields      | required | Array<String\> | Specify fields with unique key values to get node.                          |
| propertyFields | optional | Array<String\> | Specify properties to be given if the node you tried to get does not exist. |

## Import database file into Neo4j official docker image

### dump format

To import the generated database dump file into the official Neo4j docker image, download the database dump file, and run the Dockerfile as shown in the example below.

* [Dockerfile for dump](../../../../examples/Dockerfile_neo4j)

### zip format

To import the generated zipped database file into the official Neo4j docker image, download the database zip file, unzip, and run the Dockerfile as shown in the example below.

* [Dockerfile for zip](../../../../examples/Dockerfile_neo4j_zip)

To upload an image with the database file included to [Artifact Registry](https://cloud.google.com/artifact-registry) using this Dockerfile, execute the following command

```bash
docker build -f Dockerfile_neo4j -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/neo4j/graph .
```

## Deploy Neo4j API server on Cloud Run

To deploy a Neo4j API server on Cloud Run using Cloud Build, prepare and run the following cloudbuild file.

* [cloudbuild.yaml for dump format](../../../../examples/cloudbuild_neo4j.yaml)
* [cloudbuild.yaml for zip format](../../../../examples/cloudbuild_neo4j_zip.yaml)

Then execute the following command.

```shell
gcloud builds submit --config=cloudbuild.yaml --project=myproject
```

## Run local

### zip format

To download and unzip the database file locally and mount it for use when launching the Neo4j image, execute the following command

```shell
docker run \
    --name graph \
    -p7474:7474 -p7687:7687 \
    -d \
    -v {graph_db_dir_path}/data:/data \
    -v {graph_db_dir_path}/logs:/logs \
    -v {graph_db_dir_path}/import:/var/lib/neo4j/import \
    --env NEO4J_AUTH=neo4j/password \
    neo4j:5.19.0
```

## Related example config files

* [BigQuery to LocalNeo4j](../../../../examples/bigquery-to-localneo4j.json)
