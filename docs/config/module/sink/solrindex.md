# Solr index Sink Module (Experimental)

Sink module to create solr index file to specified GCS path.

The index files generated by this module can be easily imported into [Solr docker official image](https://hub.docker.com/_/solr) to build a Solr search API server.
(This module generates index file for Solr version 9)

## Sink module common parameters

| parameter | optional | type | description |
| --- | --- | --- | --- |
| name | required | String | Step name. specified to be unique in config file. |
| module | required | String | Specified `solrindex` |
| input | required | String | Step name whose data you want to write from |
| parameters | required | Map<String,Object\> | Specify the following individual parameters. |

## Solr index sink module parameters

| parameter | optional | type | description |
| --- | --- | --- | --- |
| output | required | String | GCS path for solr index file writing destination. Index files are compressed as a zip file. |
| coreName | required | String | Solr core name to create index. |
| indexSchema | optional | String | GCS path for [solr index schema file](https://solr.apache.org/guide/solr/latest/indexing-guide/schema-elements.html). If not specified, it is automatically inferred from the input data schema. (It is strongly recommended to specify it according to your use case.) |
| solrconfig | optional | SolrConfig | GCS path for [solrconfig.xml](https://solr.apache.org/guide/solr/latest/configuration-guide/configuring-solrconfig-xml.html) file if you want to set detailed index generation settings |
| groupFields | optional | Array<String\> | If you wish to group input data and generate separate index files, specify the field names to be used for grouping. Also specify the output value in Template format so that there will be separate index files saved for each value of these fields. |
| tempDirectory | optional | String | The GCS path of the temporary file export destination. If not specified, the bucket creation permission is required. |
| customConfigFiles | optional | Array<ConfigFile\> | If there are external files, such as dictionaries, that you wish to reference during index generation, specify the external file information.|


### SolrConfig parameter schema

If you want to configure the index generation environment in detail, specify parameter `solrconfig`.
The `solrconfig` parameter supports the following fields (with default values). Please refer to the [solrconfig.xml doc](https://solr.apache.org/guide/solr/latest/configuration-guide/configuring-solrconfig-xml.html) for detail of the fields.

(This setting is for index generation. It is recommended to replace solrconfig.xml when deploying the server)

```json
{
  "dataDir": "${solr.data.dir:}",
  "directoryFactory": {
    "className": "solr.NRTCachingDirectoryFactory"
  },
  "schemaFactory": {
    "className": "ClassicIndexSchemaFactory"
  },
  "codecFactory": {
    "className": "solr.SchemaCodecFactory",
    "compressionMode": "BEST_SPEED"
  },
  "indexConfig": {
    "ramBufferSizeMB": 100,
    "maxBufferedDocs": 1000,
    "useCompoundFile": false,
    "ramPerThreadHardLimitMB": 1945
  },
  "libs": [
    {
      "dir": "",
      "regex": ".*\\.jar"
    }
  ],
  "luceneMatchVersion": "9.0.0"
}
```

### ConfigFile parameter schema

If you want to refer to a custom file such as a dictionary when generating the index, you can specify `customConfigFiles` parameter to load files placed in GCS under `{SOLR_HOME}/{CORE}/conf`.

| parameter | optional | type | description |
| --- | --- | --- | --- |
| input | required | String | Specify the GCS path where you placed the file you want to refer to when generating the index |
| filename | required | String | Specify the name of the file to be copied in `{SOLR_HOME}/{CORE}/conf` directory when generating the index. |

## Import index file into solr official docker image

To import the generated index file into the official solr docker image, download the index file, unzip, and run the Dockerfile as shown in the example below.

* [Dockerfile](../../../../examples/solrindex_Dockerfile)

To upload an image with the index included to GCR using this Dockerfile, execute the following command

```bash
docker build -t gcr.io/$PROJECT_ID/mysolrindex --build-arg _CORE_NAME=mycore .
```

Note: The solrconfig.xml for index generation defines a request handler with `/select` as an endpoint by default, but it is recommended to define a customized solrconfig.xml (and solr.xml) according to your use case and replace it in the Dockerfile.

## Deploy Solr server on Cloud Run

To deploy a solr API server on Cloud Run using Cloud Build, prepare and run the following cloudbuild file.

* [cloudbuild.yaml](../../../../examples/solrindex_cloudbuild.yaml)

Then execute the following command.

```shell
gcloud builds submit --config=cloudbuild.yaml --project=myproject
```

## output parameter template format

If you want to generate index file for each value specified in `groupFields` parameter or for each FixedWindow time interval specified in the [window module](../transform/window.md) in the previous step, you can use the following template variables for separate output destination specified in `output` parameter.

| name | type | description |
| --- | --- | --- |
| `__KEY__` | String | Value of the field specified in `groupFields`. (if more than one, the values are concatenated by `#`) |
| `__WINDOW_START__` | Timestamp | Start timestamp of the window if `window` module was specified in the previous step |
| `__WINDOW_END__` | Timestamp | End timestamp of the window if `window` module was specified in the previous step. (Note that this timestamp is in the [open interval](https://en.wikipedia.org/wiki/Interval_(mathematics)#Terminology)) |

You can use `_DateTimeUtil` to refer to a function that is useful for formatting a variable of type timestamp into a string with an `output` parameter.

```
// Text format function for timestamp field

${_DateTimeUtil.formatTimestamp(__WINDOW_START__, 'yyyyMMddhh', 'Asia/Tokyo')}


// Example output parameter using `__KEY__` and `__WINDOW_START__`

gs://example-bucket/solr/myindex_${__KEY__}_${_DateTimeUtil.formatTimestamp(__WINDOW_START__, 'yyyyMMddhh', 'Asia/Tokyo')}.zip
```

Note: It is not possible to generate folders using template variables in the `output` parameter (Only file names can be generated by template variables).


## Related example config files

* [BigQuery to Solr Index(PDF parse)](../../../../examples/bigquery-pdf-to-solrindex.json)
